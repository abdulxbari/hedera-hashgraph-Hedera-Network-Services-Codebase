/*
 * Copyright (C) 2022 Hedera Hashgraph, LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package com.hedera.node.app.service.evm.store.contracts.precompile.codec;

import static org.junit.jupiter.api.Assertions.assertEquals;

import java.util.ArrayList;
import org.apache.tuweni.bytes.Bytes;
import org.hyperledger.besu.datatypes.Address;
import org.junit.jupiter.api.Test;

class EvmEncodingFacadeTest {

    private final EvmEncodingFacade subject = new EvmEncodingFacade();

    public static final Address senderAddress = Address.ALTBN128_PAIRING;

    private static final Bytes RETURN_DECIMALS_10 =
            Bytes.fromHexString(
                    "0x000000000000000000000000000000000000000000000000000000000000000a");

    private static final Bytes RETURN_3 =
            Bytes.fromHexString(
                    "0x0000000000000000000000000000000000000000000000000000000000000003");

    private static final Bytes RETURN_TOTAL_SUPPLY_FOR_50_TOKENS =
            Bytes.fromHexString(
                    "0x0000000000000000000000000000000000000000000000000000000000000032");

    private static final Bytes RETURN_TRUE =
            Bytes.fromHexString(
                    "0x0000000000000000000000000000000000000000000000000000000000000001");

    private static final Bytes RETURN_GET_TOKEN_TYPE =
            Bytes.fromHexString(
                    "0x00000000000000000000000000000000000000000000000000000000000000160000000000000000000000000000000000000000000000000000000000000001");

    private static final Bytes RETURN_IS_TOKEN_FROZEN =
            Bytes.fromHexString(
                    "0x00000000000000000000000000000000000000000000000000000000000000160000000000000000000000000000000000000"
                        + "000000000000000000000000001");

    private static final Bytes RETURN_SUCCESS_TRUE =
            Bytes.fromHexString(
                    "0x0000000000000000000000000000000000000000000000000000000000000016"
                            + "0000000000000000000000000000000000000000000000000000000000000001");

    private static final Bytes RETURN_IS_TOKEN =
            Bytes.fromHexString(
                    "0x00000000000000000000000000000000000000000000000000000000000000160000000000000000000000000000000000000000000000000000000000000001");

    private static final Bytes RETURN_NAME_TOKENA =
            Bytes.fromHexString(
                    "0x000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000"
                        + "00000000000000000000006546f6b656e410000000000000000000000000000000000000000000000000000");

    private static final Bytes RETURN_SYMBOL_F =
            Bytes.fromHexString(
                    "0x0000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000"
                        + "00000000000000000000000014600000000000000000000000000000000000000000000000000000000000000");

    private static final Bytes RETURN_TOKEN_URI_FIRST =
            Bytes.fromHexString(
                    "0x000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000"
                        + "000000000000000000000000054649525354000000000000000000000000000000000000000000000000000000");

    private static final Bytes RETURN_ADDRESS =
            Bytes.fromHexString(
                    "0x0000000000000000000000000000000000000000000000000000000000000008");

    private static final Bytes RETURN_GET_TOKEN_INFO =
            Bytes.fromHexString(
                    "0x00000000000000000000000000000000000000000000000000000000000000160000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000012000000000000000000000000000000000000000000000000000000000000001f40000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000d000000000000000000000000000000000000000000000000000000000000000dc00000000000000000000000000000000000000000000000000000000000000ea00000000000000000000000000000000000000000000000000000000000000f80000000000000000000000000000000000000000000000000000000000000016000000000000000000000000000000000000000000000000000000000000001a000000000000000000000000000000000000000000000000000000000000005cc00000000000000000000000000000000000000000000000000000000000001e0000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000003e800000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000220000000000000000000000000000000000000000000000000000000006347f08b00000000000000000000000000000000000000000000000000000000000005cd000000000000000000000000000000000000000000000000000000000076a70000000000000000000000000000000000000000000000000000000000000000077072696d617279000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008495144584446444500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000044a554d5000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000700000000000000000000000000000000000000000000000000000000000000e00000000000000000000000000000000000000000000000000000000000000220000000000000000000000000000000000000000000000000000000000000036000000000000000000000000000000000000000000000000000000000000004a000000000000000000000000000000000000000000000000000000000000005e000000000000000000000000000000000000000000000000000000000000007200000000000000000000000000000000000000000000000000000000000000860000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000020712681b9868a3e526507d8983486ef14c2626fc7bf170543a0668afa850059a00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000e0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200a0fde1c21c4b77e8a5fb6ddd68da4a6e6d22d9cfdb7202260f8731cc4a218c40000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000020a0674fe13373a2bf9492f50435bb852c0ee34d18c205d1d75c746412bd6e6ee90000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000e00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002088f4700b5519be4cadd40bd81cd4d5e22e3cfb580631348e73e655a9ca358a8c0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000020696ec08bed92e0987c694971e0c978781a9abc3f7dae06fe5dfaaa68f5c5201e0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000e00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002095b1ec8737e9baa2b640967f1524103b4f62e3683708a650a985afa9f510d8200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000e0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000204c577c652b075ebd79abdfa99501997035aec91b32fd058773625466bdd0ff370000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000001f400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005ce00000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000050000000000000000000000000000000000000000000000000000000000000190000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005cc00000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000001f400000000000000000000000000000000000000000000000000000000000005cd000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005cf00000000000000000000000000000000000000000000000000000000000000043078303300000000000000000000000000000000000000000000000000000000");

    @Test
    void decodeReturnResultForDecimals() {
        final var decodedResult = subject.encodeDecimals(10);
        assertEquals(RETURN_DECIMALS_10, decodedResult);
    }

    @Test
    void decodeReturnResultForAllowanceERC() {
        final var decodedResult = subject.encodeAllowance(3);
        assertEquals(RETURN_3, decodedResult);
    }

    @Test
    void decodeReturnResultForTotalSupply() {
        final var decodedResult = subject.encodeTotalSupply(50);
        assertEquals(RETURN_TOTAL_SUPPLY_FOR_50_TOKENS, decodedResult);
    }

    @Test
    void decodeReturnResultForBalance() {
        final var decodedResult = subject.encodeBalance(3);
        assertEquals(RETURN_3, decodedResult);
    }

    @Test
    void decodeReturnResultForIsApprovedForAllERC() {
        final var decodedResult = subject.encodeIsApprovedForAll(true);
        assertEquals(RETURN_TRUE, decodedResult);
    }

    @Test
    void decodeReturnResultForGetTokenType() {
        final var decodedResult = subject.encodeGetTokenType(1);
        assertEquals(RETURN_GET_TOKEN_TYPE, decodedResult);
    }

    @Test
    void decodeReturnResultForIsFrozen() {
        final var decodedResult = subject.encodeIsFrozen(true);
        assertEquals(RETURN_IS_TOKEN_FROZEN, decodedResult);
    }

    @Test
    void decodeReturnResultForGetTokenDefaultFreezeStatus() {
        final var decodedResult = subject.encodeGetTokenDefaultFreezeStatus(true);
        assertEquals(RETURN_SUCCESS_TRUE, decodedResult);
    }

    @Test
    void decodeReturnResultForGetTokenDefaultKycStatus() {
        final var decodedResult = subject.encodeGetTokenDefaultKycStatus(true);
        assertEquals(RETURN_SUCCESS_TRUE, decodedResult);
    }

    @Test
    void decodeReturnResultForIsKyc() {
        final var decodedResult = subject.encodeIsKyc(true);
        assertEquals(RETURN_SUCCESS_TRUE, decodedResult);
    }

    @Test
    void decodeReturnResultForIsToken() {
        final var decodedResult = subject.encodeIsToken(true);
        assertEquals(RETURN_IS_TOKEN, decodedResult);
    }

    @Test
    void decodeReturnResultForName() {
        final var decodedResult = subject.encodeName("TokenA");
        assertEquals(RETURN_NAME_TOKENA, decodedResult);
    }

    @Test
    void decodeReturnResultForSymbol() {
        final var decodedResult = subject.encodeSymbol("F");
        assertEquals(RETURN_SYMBOL_F, decodedResult);
    }

    @Test
    void decodeReturnResultForTokenUri() {
        final var decodedResult = subject.encodeTokenUri("FIRST");
        assertEquals(RETURN_TOKEN_URI_FIRST, decodedResult);
    }

    @Test
    void decodeReturnResultForOwner() {
        final var decodedResult = subject.encodeOwner(senderAddress);
        assertEquals(RETURN_ADDRESS, decodedResult);
    }

    @Test
    void decodeReturnResultForGetApprovedERC() {
        final var decodedResult = subject.encodeGetApproved(senderAddress);
        assertEquals(RETURN_ADDRESS, decodedResult);
    }

    @Test
    void decodeGetTokenInfo() {
        final var tokenInfo =
                new EvmTokenInfo(
                        fromHexString("0x03"),
                        1,
                        false,
                        "IQDXDFDE",
                        "primary",
                        "JUMP",
                        Address.wrap(
                                Bytes.fromHexString("0x00000000000000000000000000000000000005cc")),
                        500L,
                        1000L,
                        1,
                        1665659019L);

        tokenInfo.setAutoRenewAccount(
                Address.wrap(Bytes.fromHexString("0x00000000000000000000000000000000000005cd")));
        tokenInfo.setIsPaused(true);
        tokenInfo.setAutoRenewPeriod(7776000L);
        tokenInfo.setDefaultFreezeStatus(true);
        tokenInfo.setDefaultKycStatus(true);

        tokenInfo.setAdminKey(
                new EvmKey(
                        Address.ZERO,
                        new byte[] {
                            113, 38, -127, -71, -122, -118, 62, 82, 101, 7, -40, -104, 52, -122,
                            -17, 20, -62, 98, 111, -57, -65, 23, 5, 67, -96, 102, -118, -6, -123, 0,
                            89, -96
                        },
                        new byte[0],
                        Address.ZERO));

        tokenInfo.setKycKey(
                new EvmKey(
                        Address.ZERO,
                        new byte[] {
                            10, 15, -34, 28, 33, -60, -73, 126, -118, 95, -74, -35, -42, -115, -92,
                            -90, -26, -46, 45, -100, -3, -73, 32, 34, 96, -8, 115, 28, -60, -94, 24,
                            -60
                        },
                        new byte[0],
                        Address.ZERO));

        tokenInfo.setWipeKey(
                new EvmKey(
                        Address.ZERO,
                        new byte[] {
                            -120, -12, 112, 11, 85, 25, -66, 76, -83, -44, 11, -40, 28, -44, -43,
                            -30, 46, 60, -5, 88, 6, 49, 52, -114, 115, -26, 85, -87, -54, 53, -118,
                            -116
                        },
                        new byte[0],
                        Address.ZERO));

        tokenInfo.setPauseKey(
                new EvmKey(
                        Address.ZERO,
                        new byte[] {
                            76, 87, 124, 101, 43, 7, 94, -67, 121, -85, -33, -87, -107, 1, -103,
                            112, 53, -82, -55, 27, 50, -3, 5, -121, 115, 98, 84, 102, -67, -48, -1,
                            55
                        },
                        new byte[0],
                        Address.ZERO));

        tokenInfo.setFeeScheduleKey(
                new EvmKey(
                        Address.ZERO,
                        new byte[] {
                            -107, -79, -20, -121, 55, -23, -70, -94, -74, 64, -106, 127, 21, 36, 16,
                            59, 79, 98, -29, 104, 55, 8, -90, 80, -87, -123, -81, -87, -11, 16, -40,
                            32
                        },
                        new byte[0],
                        Address.ZERO));

        tokenInfo.setFreezeKey(
                new EvmKey(
                        Address.ZERO,
                        new byte[] {
                            -96, 103, 79, -31, 51, 115, -94, -65, -108, -110, -11, 4, 53, -69, -123,
                            44, 14, -29, 77, 24, -62, 5, -47, -41, 92, 116, 100, 18, -67, 110, 110,
                            -23
                        },
                        new byte[0],
                        Address.ZERO));

        tokenInfo.setSupplyKey(
                new EvmKey(
                        Address.ZERO,
                        new byte[] {
                            105, 110, -64, -117, -19, -110, -32, -104, 124, 105, 73, 113, -32, -55,
                            120, 120, 26, -102, -68, 63, 125, -82, 6, -2, 93, -6, -86, 104, -11,
                            -59, 32, 30
                        },
                        new byte[0],
                        Address.ZERO));

        final var fixedFee =
                new FixedFee(
                        500L,
                        Address.ZERO,
                        false,
                        false,
                        Address.wrap(
                                Bytes.fromHexString("0x00000000000000000000000000000000000005ce")));

        final var fractionFee =
                new FractionalFee(
                        1,
                        2,
                        5,
                        400,
                        false,
                        Address.wrap(
                                Bytes.fromHexString("0x00000000000000000000000000000000000005cc")));

        final var royaltyFee =
                new RoyaltyFee(
                        1,
                        2,
                        500L,
                        Address.wrap(
                                Bytes.fromHexString("0x00000000000000000000000000000000000005cd")),
                        false,
                        Address.wrap(
                                Bytes.fromHexString("0x00000000000000000000000000000000000005cf")));

        var customFees1 = new CustomFee();
        customFees1.setFixedFee(fixedFee);
        var customFees2 = new CustomFee();
        customFees2.setFractionalFee(fractionFee);
        var customFee3 = new CustomFee();
        customFee3.setRoyaltyFee(royaltyFee);
        var customFees = new ArrayList<CustomFee>();
        customFees.add(customFees1);
        customFees.add(customFees2);
        customFees.add(customFee3);

        tokenInfo.setCustomFees(customFees);

        final var encodeResult = subject.encodeGetTokenInfo(tokenInfo);
        assertEquals(RETURN_GET_TOKEN_INFO, encodeResult);
        assertEquals(1, tokenInfo.getDecimals());
    }

    private byte[] fromHexString(final String value) {
        return Bytes.fromHexString(value).toArray();
    }
}
